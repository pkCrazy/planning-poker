@using Microsoft.AspNetCore.SignalR.Client
@using PlaningPoker.Shared
@inject NavigationManager Navigation
@implements IAsyncDisposable

<h3>User: @Username</h3>

<button @onclick="() => Vote(0)" disabled="@IsConnectionFailed">0</button>
<button @onclick="() => Vote(1)" disabled="@IsConnectionFailed">1</button>
<button @onclick="() => Vote(2)" disabled="@IsConnectionFailed">2</button>
<button @onclick="() => Vote(3)" disabled="@IsConnectionFailed">3</button>
<button @onclick="() => Vote(5)" disabled="@IsConnectionFailed">5</button>
<button @onclick="() => Vote(8)" disabled="@IsConnectionFailed">8</button>
<button @onclick="() => Vote(13)" disabled="@IsConnectionFailed">13</button>
<button @onclick="() => Vote(20)" disabled="@IsConnectionFailed">20</button>
<button @onclick="() => Vote(40)" disabled="@IsConnectionFailed">40</button>
<button @onclick="() => Vote(100)" disabled="@IsConnectionFailed">100</button>

<h4>Players</h4>
<ul>
    @foreach (var player in _players)
    {
        <li>
            Username: @player.Value.Username

            @if (_areVotesVisible)
            {
                @if (player.Value.Vote is not null)
                {
                    <div>
                        Vote: @player.Value.Vote
                    </div>
                }
            }
            else
            {
                @if (player.Value.Vote is not null)
                {
                    <div>
                        blue square
                    </div>
                }
            }
        </li>
    }
</ul>

<button @onclick="NewVote" disabled="@IsConnectionFailed">New vote</button>
<button @onclick="ShowVotes" disabled="@IsConnectionFailed">Show votes</button>

@if (IsConnectionFailed)
{
    <div style="background-color: red; color: white;">
        Connection failed. Try to reconnect. <button @onclick="@(async () => await ConnectionFailed.InvokeAsync())">Ok</button>
    </div>
}

@code {
    private const int ExpectedMaximumPlayes = 10;

    private HubConnection? _hubConnection;
    private Dictionary<Guid, Player> _players = new(ExpectedMaximumPlayes);
    private bool _areVotesVisible = false;

    private bool IsConnectionFailed { get; set; }

    [Parameter, EditorRequired]
    public string Username { get; init; } = string.Empty;

    [Parameter]
    public EventCallback ConnectionFailed { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/pokerhub"))
            .Build();

        _hubConnection.On<IEnumerable<Player>, bool>("PlayerConnected", OnPlayersConnected);
        _hubConnection.On<IEnumerable<Player>>("PlayerDisconnected", SetPlayers);
        _hubConnection.On<Player>("PlayerVoted", OnPlayerVoted);
        _hubConnection.On<IEnumerable<Player>>("NewVote", OnNewVote);
        _hubConnection.On("ShowVotes", OnShowVotes);

        try
        {
            await _hubConnection.StartAsync();
            await _hubConnection.SendAsync("PlayerConnected", Guid.NewGuid(), Username);
        }
        catch (HttpRequestException)
        {
            IsConnectionFailed = true;
        }
    }

    private void OnPlayersConnected(IEnumerable<Player> players, bool areVotesVisible)
    {
        _players = players.ToDictionary(x => x.Id, x => x);

        _areVotesVisible = areVotesVisible;

        StateHasChanged();
    }

    private void SetPlayers(IEnumerable<Player> players)
    {
        _players = players.ToDictionary(x => x.Id, x => x);

        StateHasChanged();
    }

    private async Task Vote(int number)
    {
        if (_hubConnection?.State is HubConnectionState.Connected)
        {
            await _hubConnection.SendAsync("Vote", number);
        }
    }

    private void OnPlayerVoted(Player player)
    {
        _players[player.Id] = player;

        StateHasChanged();
    }

    private async Task NewVote()
    {
        if (_hubConnection?.State is HubConnectionState.Connected)
        {
            await _hubConnection.SendAsync("NewVote");
        }
    }

    private void OnNewVote(IEnumerable<Player> players)
    {
        _players = players.ToDictionary(x => x.Id, x => x);

        _areVotesVisible = false;

        StateHasChanged();
    }

    private async Task ShowVotes()
    {
        if (_hubConnection?.State is HubConnectionState.Connected)
        {
            await _hubConnection.SendAsync("ShowVotes");
        }
    }

    private void OnShowVotes()
    {
        _areVotesVisible = true;

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
